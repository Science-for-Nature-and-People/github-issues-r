---
title: "Github Issues"
author: "Robert Saldivar"
date: "7/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}

library(tidyverse)
library(gh)
library(purrr)
library(tidyr)
library(curl)
library(keyring)

```

```{r}

# The Example for this comes from https://github.com/jennybc/analyze-github-stuff-with-r

#Example Code

issues_gh <- gh("/repos/brunj7/nceas-r-packages/issues", owner = "brunj7", repo = "nceas-r-packages", state = "all")


map_chr_hack <- function(.x, .f, ...) {
  map(.x, .f, ...) %>%
    map_if(is.null, ~ NA_character_) %>%
    flatten_chr()
}

issue_gh_df <- issues_gh %>%
  {
  data.frame(number = map_int(., "number"), #Calls the issue number
             id = map_int(., "id"), #Calls the issue id
             title = map_chr(., "title"), #Calls the title of the issue
             state = map_chr(., "state"), #States if the issue is open or closed
             opener = map_chr(., c("user", "login")), #The user who created the issue
             created_at = map_chr(., "created_at") %>% as.Date(), #The date the issue was created
             closed_at = map_chr_hack(., "closed_at") %>% as.Date(), #The date the issued was closed
             n_comments = map_int(., "comments") #This is the number of comments in an issue
             )
    }

```


```{r}
#This section will demonstrate how to use the keyring package to store tokens.

#Keyring allows the user to set multiple tokens without needing to set them in the environment

#Here is a link to a youtube video demonstrating how to use the keyring package: https://www.youtube.com/watch?v=Q8Cilx-MOsU

#Here is a link demondstrating how to get tokens from github: https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token


#This is going to create a new keyring to store tokens
#keyring::keyring_create("Example_Keyring") #this only needs to be run once


#This sets a password in the keyring
#keyring::key_set_with_value(service= "Key", #This is what will be called when using the keyring to access the stored token
#  password= "Password", # this is the password/token that is being saved
#  keyring= "Example_Keyring" #This is the keyring that the password is being associated with
#  )


#Example of how to use keyring with gh
#gh("/repos/:user/:repo", .token = keyring::key_get(service = "Key", keyring = "Example_Keyring"))

#Alternatively you can store token in .renviron by
#usethis::edit_r_environ()
#GITHUB_PAT = password

#Here is a good reference for setting .renviron: https://rstats.wtf/r-startup.html


```


```{r}
# This section will be to try to access a private repo


gh_issues_private <- gh("/repos/Science-for-Nature-and-People/github-issues-r/issues", 
                        owner = "Science-for-Nature-and People", 
                        repo = "github-issues-r", 
                        state = "all", 
                        .token = NULL # Token is set to NULL because GITHUB_PAT has been set in my .Renviron, if someone uses this code without it set it will fail.
                          #keyring::key_get("Github_Token", keyring = "Git_Credentials") 
                        )
                          

gh_issues_private_df <- gh_issues_private %>%
  {
  data.frame(number = map_int(., "number"), #Calls the issue number
             id = map_int(., "id"), #Calls the issue id
             title = map_chr(., "title"), #Calls the title of the issue
             state = map_chr(., "state"), #States if the issue is open or closed
             opener = map_chr(., c("user", "login")), #The user who created the issue
             created_at = map_chr(., "created_at") %>% as.Date(), #The date the issue was created
             closed_at = map_chr_hack(., "closed_at") %>% as.Date(), #The date the issued was closed
             n_comments = map_int(., "comments") #This is the number of comments in an issue
             )
    }


```



```{r}
#Trying to use the gh function on the snapp_wg_scicomp repo which a github enterprise repo.


snapp_wg_scicomp_issues <- gh("/repos/SNAPP/snapp-wg-scicomp/issues", 
                              .api_url = "https://github.nceas.ucsb.edu/api/v3", 
                              owner = "SNAPP", 
                              repo = "snapp-wg-scicomp", 
                              
                              #For this section of code to work the token from github enterprise needs to have been set in a keyring named "Git_Credentials" and name the value "Enterprise token"
                              .token = keyring::key_get("Github_Enterprise_Token", keyring = "Git_Credentials"), 
                              
                              
                              state = "all",
                              .limit = "all")  %>%
  {
  data.frame(number = map_int(., "number"), #Calls the issue number
             id = map_int(., "id"), #Calls the issue id
             title = map_chr(., "title"), #Calls the title of the issue
             state = map_chr(., "state"), #States if the issue is open or closed
             user = map_chr(., c("user", "login")), #The user who created the issue
             created_at = map_chr(., "created_at") %>% as.Date(), #The date the issue was created
             closed_at = map_chr_hack(., "closed_at") %>% as.Date(), #The date the issued was closed
             n_comments = map_int(., "comments") #This is the number of comments in an issue #The date the issue was created
             )
  }

```
