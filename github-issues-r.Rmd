---
title: "Github Issues"
author: "Robert Saldivar"
date: "7/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(gh)
library(purrr)
library(tidyr)
library(curl)


library(httr)
library(jsonlite)

```

```{r}

# The Exampe for this comes from https://github.com/jennybc/analyze-github-stuff-with-r

#Example Code

issues_gh <- gh("/repos/brunj7/nceas-r-packages/issues", owner = "brunj7", repo = "nceas-r-packages", state = "all")


map_chr_hack <- function(.x, .f, ...) {
  map(.x, .f, ...) %>%
    map_if(is.null, ~ NA_character_) %>%
    flatten_chr()
}

issue_gh_df <- issues %>%
  {
  data.frame(number = map_int(., "number"), #Calls the issue number
             id = map_int(., "id"), #Calls the issue id
             title = map_chr(., "title"), #Calls the title of the issue
             state = map_chr(., "state"), #States if the issue is open or closed
             opener = map_chr(., c("user", "login")), #The user who created the issue
             created_at = map_chr(., "created_at") %>% as.Date(), #The date the issue was created
             closed_at = map_chr_hack(., "closed_at") %>% as.Date(), #The date the issued was closed
             n_comments = map_int(., "comments") #This is the number of comments in an issue
             )
    }

```


```{r}
#Trying to use the gh function on the snapp_wg_scicomp repo which is private.

#Not functioning yet

#snapp_wg_scicomp_issues <- gh("/repos/SNAPP/snapp_wg_scicomp/issues", username = "robertsaldivar", type = "private", page = 1) # %>%
 # {
  #data.frame(number = map_int(., "number"), #Calls the issue number
   #          id = map_int(., "id"), #Calls the issue id
    #         title = map_chr(., "title"), #Calls the title of the issue
     #        state = map_chr(., "state"), #States if the issue is open or closed
      #       user = map_chr(., c("user", "login")), #The user who created the issue
       #      created_at = map_chr(., "created_at") %>% as.Date(), #The date the issue was created
        #     closed_at = map_chr_hack(., "closed_at") %>% as.Date(), #The date the issued was closed
         #    n_comments = map_int(., "comments") #This is the number of comments in an issue #The date the issue was created
          #   )
    #}
  
```

```{r}
# Looking into another method of getting the issues httr

# The a walk through of the code is available from https://blog.exploratory.io/analyzing-issue-data-with-github-rest-api-63945017dedc

issues_httr <- GET("https://github.com/brunj7/nceas-r-packages/issues")

#(issues_httr)

issues_httr_json <- content(issues_httr, type = "text")

issues_httr_df <- fromJSON(issues_httr_json) #This is causing an error
#Error: lexical error: invalid char in json text. <!DOCTYPE html> <html lang="en" (right here) ------^

```



```{r}
#Example of using the httr function from blog https://blog.exploratory.io/analyzing-issue-data-with-github-rest-api-63945017dedc

library(httr)
res <- GET("https://api.github.com/repos/hadley/dplyr/issues", 
           query = list(state = "all", per_page = 100, page = 1))
jsondata <- content(res, type = "text")
library(jsonlite)
github_df <- fromJSON(jsondata, flatten = TRUE)
```

